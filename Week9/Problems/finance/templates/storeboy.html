
{% extends "layout.html" %}
{% block title %}
    Buy
{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
{% endblock %}
{% block main %}
    <form id="buy-form" action="/buy" method="post">
        <div class="mb-3">
            <input autofocus class="form-control mx-auto w-auto" name="symbol" placeholder="Symbol" type="text">
        </div>
        <div class="mb-3">
            <input autofocus class="form-control mx-auto w-auto" name="shares" placeholder="Shares" type="text">
        </div>
        <input type="hidden" name="price" value="{{ price }}">
        <input type="hidden" name="purchase_cost" value="{{ purchase_cost }}">
        <button id="confirm-btn" type="button" class="btn btn-primary" data-toggle="modal" data-target="#confirmModal">
            Open Confirmation
        </button>
    </form>

    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Purchase</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to purchase<span id="shares">{{ shares }}</span>shares of</span><span id="symbol">{{ symbol }}</span>at $<span id="price">{{ price }}</span> for a total of <span id="total">{{ purchase_cost }}</span>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="confirmPurchaseBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function confirmForm() {
        document.getElementById("buy-form").submit();
    }

        // Function to set values in the modal before displaying
        $('#confirmModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var symbol = document.getElementsByName("symbol")[0].value;
            var shares = document.getElementsByName("shares")[0].value;
            var price = document.getElementsByName("price")[0].value;
            var purchase_cost = document.getElementsByName("purchase_cost")[0].value;
            var modal = $(this);
            modal.find('.modal-body #symbol').text(symbol);
            modal.find('.modal-body #shares').text(shares);
            modal.find('.modal-body #price').text(price);
            modal.find('.modal-body #total').text(purchase_cost);
        });

        // Function to submit the form when confirmation is clicked
        $('#confirmPurchaseBtn').click(function() {
            $('#buy-form').submit();
        });
</script>





<!--
                        <div class="modal-body">
                            Are you sure you want to purchase <span id="shares"></span> shares of <span id="symbol"></span> at $<span id="price"></span> for a total of <span id="total"></span>?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="confirmPurchaseBtn">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endblock %}

        {% block scripts %}
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
            <script>
                $(document).ready(function() {
                    $('#confirmModal').on('show.bs.modal', function(event) {
                        var symbol = document.getElementsByName("symbol")[0].value;
                        var shares = document.getElementsByName("shares")[0].value;
                        var price = document.getElementsByName("price")[0].value;
                        var purchase_cost = document.getElementsByName("purchase_cost")[0].value;
                        var modal = $(this);
                        modal.find('.modal-body #symbol').text(symbol);
                        modal.find('.modal-body #shares').text(shares);
                        modal.find('.modal-body #price').text(price);
                        modal.find('.modal-body #total').text(purchase_cost);
                    });

                    $('#confirmPurchaseBtn').click(function() {
                        $('#buy-form').submit();
                    });
                });
            </script>
        {% endblock %}




          <script>
    $(document).ready(function() {
        $('#confirmModal').on('show.bs.modal', function(event) {
            var symbol = document.getElementsByName("symbol")[0].value;
            var shares = document.getElementsByName("shares")[0].value;
            var price = {{ price }};
            var purchase_cost = {{ purchase_cost }};
            var modal = $(this);
            modal.find('.modal-body #symbol').text(symbol);
            modal.find('.modal-body #shares').text(shares);
            modal.find('.modal-body #price').text(price);
            modal.find('.modal-body #total').text(purchase_cost);
        });

        $('#confirmPurchaseBtn').click(function() {
            $('#buy-form').submit();
        });
    });
</script>
-->



{% extends "layout.html" %}
{% block title %}
    Buy
{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
{% endblock %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmation Modal Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <form id="buy-form" action="/buy" method="post">
    <div class="mb-3">
        <input autofocus class="form-control mx-auto w-auto" name="symbol" placeholder="Symbol" type="text">
    </div>
    <div class="mb-3">
        <input autofocus class="form-control mx-auto w-auto" name="shares" placeholder="Shares" type="text">
    </div>
    <input type="hidden" name="price" value="{{ price }}">
    <input type="hidden" name="purchase_cost" value="{{ purchase_cost }}">
    <button id="confirm-btn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
      Purchase
    </button>
  </form>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmModalLabel">Confirm Purchase</h5>
            </div>
            <div class="modal-body">
                Are you sure you want to perform this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>







<div class="modal-body">
    Would you like to purchase <b><span id="shares"></span></b> share(s) of <b><span id="symbol"></span></b> at <b>${{price}}</b> a stock for a total of <b>${{purchase_cost}}</b>?
</div>









@app.route("/buy", methods=["GET", "POST"])
@login_required
def buy():
    """Buy shares of stock"""
    if request.method == "POST":
        symbol = request.form.get("symbol").upper()
        shares = request.form.get("shares")

        if not symbol:
            return apology("You didn't enter a symbol :(", 400)
        if not shares:
            return apology("You didn't enter any shares :(", 400)
        shares = int(shares)
        if shares <= 0:
            return apology("Invalid number of shares", 400)

        quote = lookup(symbol)
        if quote is None:
            return apology("Invalid symbol", 400)
        price = quote["price"]
        purchase_cost = shares * price

        cash = db.execute("SELECT cash FROM users WHERE id = :user_id", user_id=session["user_id"])[0]["cash"]
        if purchase_cost > cash:
            return apology("Insufficient funds", 400)

        # Update user's cash .. user_id is from the user id of the current session
        db.execute("UPDATE users SET cash = cash - :purchase_cost WHERE id = :user_id",
                    purchase_cost=purchase_cost, user_id=session["user_id"])

        # Add purchase to history
        db.execute("INSERT INTO transactions (user_id, symbol, shares, price) VALUES (:user_id, :symbol, :shares, :price)",
                    user_id=session["user_id"], symbol=symbol, shares=shares, price=price)

        flash(f"Purchased {shares} shares of {symbol} for {usd(purchase_cost)}!")
        return render_template("buy.html", symbol=symbol, shares=shares, price=price, purchase_cost=purchase_cost)
    else:
        return render_template("buy.html", symbol="", shares="", price="", purchase_cost="")
